---
import '../styles/global.css';
import EncodedContact from '../components/EncodedContact.astro';
import LanguageSelector from '../components/LanguageSelector.astro';
import { defaultLang, useTranslations, type Lang } from '../i18n';
import AnalyticsEvents from '../components/AnalyticsEvents.astro';

interface Props {
	title: string;
	description?: string;
}

const { title, description = "Diogo Soares - Senior Product Manager | Building impactful technology solutions" } = Astro.props;

// Default to 'en' for SSR, client-side will detect and update
const lang: Lang = defaultLang;
const t = useTranslations(lang);

// Logic for Projects link
const currentPath = Astro.url.pathname;
const isHome = currentPath === '/' || currentPath === '/en' || currentPath === '/en/';
const projectsHref = isHome ? "#projects" : (currentPath.startsWith('/en') ? "/en/projects" : "/projects");
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content={description} />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
		
		<!-- Open Graph / Facebook -->
		<meta property="og:type" content="website" />
		<meta property="og:url" content={Astro.url} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta name="referrer" content="strict-origin-when-cross-origin" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GJPVRQBNL2"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-GJPVRQBNL2');
    </script>

		<!-- JSON-LD for Person -->
		<script type="application/ld+json">
			{
				"@context": "https://schema.org",
				"@type": "Person",
				"name": "Diogo Soares",
				"jobTitle": "Senior Product Manager",
				"url": "https://diogosoares.com",
				"telephone": "+55 31 97234-6884",
				"email": "diogosp@gmail.com",
				"sameAs": [
					"https://linkedin.com/in/diogo-soares-pm/"
				]
			}
		</script>
		
		<!-- i18n initialization script -->
	<script>
			import { initLang, getPreferredLang, useTranslations } from '../i18n';
			
			const setupI18n = () => {
				const lang = initLang();
				const t = useTranslations(lang);
				
				// Update translatable elements
				document.querySelectorAll('[data-i18n]').forEach((el) => {
					const key = el.getAttribute('data-i18n');
					if (key) {
						const translated = t(key as any);
						if (translated) {
							el.textContent = translated;
						}
					}
				});
			};

			// Run immediately since script is a module
			setupI18n();

			// Also run on view transitions if enabled
			document.addEventListener('astro:page-load', setupI18n);

      // Handle "Let's Talk" click
      document.addEventListener('DOMContentLoaded', () => {
        const handleLetsTalk = (e: Event) => {
          const target = e.target as HTMLElement;
          if (target && target.closest('#lets-talk-btn')) {
            e.preventDefault();
            const footer = document.getElementById('contact-footer');
            if (footer) {
              footer.scrollIntoView({ behavior: 'smooth' });
              
              // Add highlight effect
              setTimeout(() => {
                footer.classList.add('bg-accent/10');
                setTimeout(() => {
                  footer.classList.remove('bg-accent/10');
                }, 1500);
              }, 500);
            }
          }
        };

        // Attach to document to handle it even after view transitions (if using them later)
        // or re-attaching on page load
        document.addEventListener('click', handleLetsTalk);
      });
		</script>
	</head>
	<body class="flex flex-col min-h-screen">
		<header class="fixed top-0 w-full bg-surface/90 backdrop-blur-md z-50 border-b border-border">
			<nav class="section-container h-16 flex items-center justify-between">
				<a href="/" class="text-xl font-display tracking-tight text-text">Diogo<span class="text-accent">.cv</span></a>
				<div class="flex items-center gap-4 md:gap-6">
					<div class="hidden md:flex items-center gap-6">
						<a href={projectsHref} class="link-hover text-sm" data-i18n="nav.projects">Projects</a>
						<a href="/cv" class="link-hover text-sm" data-i18n="nav.cv">CV</a>
					</div>
					<LanguageSelector />
					<a href="#contact-footer" id="lets-talk-btn" class="btn-accent text-sm py-2 px-4" data-i18n="nav.letsTalk">Let's Talk</a>
				</div>
			</nav>
		</header>

		<main class="flex-grow pt-16">
			<slot />
		</main>

		<footer id="contact-footer" class="bg-surface-elevated py-16 transition-all duration-1000 ease-in-out">
			<div class="section-container">
				<div class="text-center text-xs text-text-muted">
					<p>Â© {new Date().getFullYear()} Diogo Soares. <span data-i18n="footer.builtWith">Built with purpose.</span></p>
				</div>
			</div>
		</footer>
    <AnalyticsEvents />
	</body>
</html>
